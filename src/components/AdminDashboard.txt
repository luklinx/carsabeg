// src/components/AdminDashboard.tsx
"use client";

import { useState, useEffect } from "react";
import { fetchCars, addCar, updateCar, deleteCar } from "@/services/api";
import { Car } from "@/types";

export default function AdminDashboard() {
  const [cars, setCars] = useState<Car[]>([]);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState<Partial<Car>>({
    make: "",
    model: "",
    year: "",
    price: 0,
    mileage: 0,
    condition: "Foreign Used",
    images: [""],
    description: "",
    featured: false,
  });

  useEffect(() => {
    loadCars();
  }, []);

  const loadCars = async () => {
    const data = await fetchCars();
    setCars(data);
    setLoading(false);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form.make || !form.model) return alert("Fill make & model");

    if (form.id) {
      await updateCar(form as Car);
    } else {
      await addCar(form as Omit<Car, "id">);
    }
    setForm({
      make: "",
      model: "",
      year: "",
      price: 0,
      mileage: 0,
      condition: "Foreign Used",
      images: [""],
      description: "",
      featured: false,
    });
    loadCars();
  };

  const handleDelete = async (id: string) => {
    if (confirm("Delete this car?")) {
      await deleteCar(id);
      loadCars();
    }
  };

  const toggleFeatured = async (car: Car) => {
    await updateCar({ ...car, featured: !car.featured });
    loadCars();
  };

  if (loading)
    return (
      <div className="p-10 text-center text-3xl font-black">
        Loading Admin...
      </div>
    );

  return (
    <div className="min-h-screen bg-gray-100 py-10">
      <div className="container mx-auto px-6 max-w-6xl">
        <h1 className="text-3xl font-black text-center mb-10 text-green-600">
          CARS ABEG ADMIN
        </h1>

        {/* Add/Edit Form */}
        <div className="bg-white rounded-3xl shadow-2xl p-8 mb-12">
          <h2 className="text-3xl font-black mb-6">
            {form.id ? "Edit" : "Add New"} Car
          </h2>
          <form onSubmit={handleSubmit} className="grid md:grid-cols-2 gap-6">
            <input
              placeholder="Make (e.g. Toyota)"
              value={form.make}
              onChange={(e) => setForm({ ...form, make: e.target.value })}
              className="p-4 border-2 rounded-xl text-xl font-bold"
              required
            />
            <input
              placeholder="Model (e.g. Camry)"
              value={form.model}
              onChange={(e) => setForm({ ...form, model: e.target.value })}
              className="p-4 border-2 rounded-xl text-xl font-bold"
              required
            />
            <input
              type="number"
              placeholder="Year"
              value={form.year}
              onChange={(e) => setForm({ ...form, year: e.target.value })}
              className="p-4 border-2 rounded-xl text-xl font-bold"
              required
            />
            <input
              type="number"
              placeholder="Price (₦)"
              value={form.price}
              onChange={(e) =>
                setForm({ ...form, price: Number(e.target.value) })
              }
              className="p-4 border-2 rounded-xl text-xl font-bold"
              required
            />
            <input
              type="number"
              placeholder="Mileage"
              value={form.mileage}
              onChange={(e) =>
                setForm({ ...form, mileage: Number(e.target.value) })
              }
              className="p-4 border-2 rounded-xl text-xl font-bold"
            />
            <select
              value={form.condition}
              onChange={(e) =>
                setForm({ ...form, condition: e.target.value as any })
              }
              className="p-4 border-2 rounded-xl text-xl font-bold"
            >
              <option>Foreign Used</option>
              <option>Nigerian Used</option>
            </select>
            <input
              placeholder="Image URL"
              value={form.images?.[0] || ""}
              onChange={(e) => setForm({ ...form, images: [e.target.value] })}
              className="p-4 border-2 rounded-xl text-xl font-bold md:col-span-2"
            />
            <textarea
              placeholder="Description (optional)"
              value={form.description}
              onChange={(e) =>
                setForm({ ...form, description: e.target.value })
              }
              className="p-4 border-2 rounded-xl text-xl font-bold md:col-span-2 h h-32"
            />
            <button
              type="submit"
              className="bg-green-600 hover:bg-green-700 text-white font-black text-2xl py-6 rounded-2xl shadow-2xl md:col-span-2"
            >
              {form.id ? "UPDATE" : "ADD"} CAR
            </button>
          </form>
        </div>

        {/* Cars List */}
        <div className="grid gap-6">
          {cars.map((car) => (
            <div
              key={car.id}
              className="bg-white rounded-3xl shadow-xl p-6 flex flex-col md:flex-row items-center gap-6"
            >
              <img
                src={car.images[0]}
                alt={car.model}
                className="w-full md:w-48 h-48 object-cover rounded-2xl"
              />
              <div className="flex-1">
                <h3 className="text-3xl font-black">
                  {car.year} {car.make} {car.model}
                </h3>
                <p className="text-2xl font-bold text-green-600">
                  ₦{(car.price / 1000000).toFixed(1)}M
                </p>
                <p className="text-lg">
                  {car.condition} • {car.mileage.toLocaleString()} km
                </p>
                {car.featured && (
                  <span className="inline-block bg-yellow-400 text-black px-4 py-2 rounded-full font-black mt-2">
                    FEATURED
                  </span>
                )}
              </div>
              <div className="flex gap-4">
                <button
                  onClick={() => setForm(car)}
                  className="bg-blue-600 text-white px-8 py-4 rounded-xl font-black text-xl"
                >
                  Edit
                </button>
                <button
                  onClick={() => toggleFeatured(car)}
                  className={`px-8 py-4 rounded-xl font-black text-xl ${
                    car.featured ? "bg-gray-600" : "bg-yellow-500"
                  } text-white`}
                >
                  {car.featured ? "Unfeature" : "Feature"}
                </button>
                <button
                  onClick={() => handleDelete(car.id)}
                  className="bg-red-600 text-white px-8 py-4 rounded-xl font-black text-xl"
                >
                  Delete
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
